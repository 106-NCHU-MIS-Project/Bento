<!DOCTYPE html>
<html>
  <head>

    <style>
  #map {
    height: 400px;
    width: 100%;
   }
</style>
  </head>
  <body>
<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
<script src="jquery.min.js"></script>
<script src="jquery.tinyMap‐3.4.10.min.js"></script>
<script>

  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDd2rFHwPXyIkq0iRSinBBfzg31NYJLapE",
    authDomain: "nchumis2017-5566.firebaseapp.com",
    databaseURL: "https://nchumis2017-5566.firebaseio.com",
    projectId: "nchumis2017-5566",
    storageBucket: "nchumis2017-5566.appspot.com",
    messagingSenderId: "501160127423"
  };
  firebase.initializeApp(config);


  /////////////////初始化////////////////////

  var database = firebase.database();
  var map;
  var marker;
  var uluru = {lat: 24.121045, lng: 120.673275};
  var id = null;

  // Initialize Google map

     function initMap() {
       map = new google.maps.Map(document.getElementById('map'), {
         zoom: 13,
         center: uluru
       });

  ////////新增Marker/////////////////////////////

////////////////////////////////////////////////////////
       marker = new google.maps.Marker({
         position: uluru,
         map: map
       });
     }
////////取得現在地址////////////////////////////
    function setPosition(id){
     if (navigator.geolocation) {
           navigator.geolocation.getCurrentPosition(function(position){
             writeData(id,position.coords.latitude,position.coords.longitude);
           });
       } else {
           console.log("Geolocation is not supported by this browser.");
       }
    }

   function writeData(id,latitude,longitude){
     database.ref("Deliverys/Man"+id).update({
       Latitude:latitude,
       Longitude:longitude
     });
   }

/////將地址轉爲經緯度////////////////////
function addressToLatLng(addr) {
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({
        "address": addr
    }, function (results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            map.setCenter(results[0].geometry.location);
            var marker = new google.maps.Marker({
	                map: map,
	                position: results[0].geometry.location
	            });
              var bounds = new google.maps.LatLngBounds();
              bounds.extend(results[0].geometry.location);
              map.fitBounds(bounds);
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }
    });
}
//////////////////讀資料////////////////////////
  function readAddress(){
    database.ref("Orders/EM7412/OrderInfo").on("value", function(snapshot) {
      var a = snapshot.val().Address;
      addressToLatLng(a);
  });
  }


    function readAddress2(){
      database.ref("Orders/IC6558/OrderInfo").on("value", function(snapshot) {
        var a = snapshot.val().Address;
        addressToLatLng(a);
    });
    }

    function readAddress3(){
      database.ref("Orders/QA8088/OrderInfo").on("value", function(snapshot) {
      var a = snapshot.val().Address;
      addressToLatLng(a);
    });
    }
/////////////////////////////////////////////////
  function resetPosition(){

     if (navigator.geolocation) {
           navigator.geolocation.getCurrentPosition(function(position){
             var a = position.coords.latitude;
             var b = position.coords.longitude;
             marker.setMap(null);
             var haightAshbury = {lat: a, lng: b};
             marker = new google.maps.Marker({
                 position: haightAshbury,
                 map: map,
                 center: haightAshbury
               });
               var center = new google.maps.LatLng(a, b);
               ////map.setZoom(17);
               map.panTo(center);
             document.getElementById("demo").innerHTML = "Latitude:"+a+"<br>Longitude:"+b;
      })
    }else {
           console.log("Geolocation is not supported by this browser.");
       }

}
  readAddress();
  readAddress2();
  readAddress3();
  var t1 = window.setInterval("setPosition("+id+")",15000);
  var t2 = window.setInterval("resetPosition()",5000);


</script>

<div id="map"></div>
<p id="demo"></p>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9niNiTIfnyVn4nZKieMFr_QXJb5ZV7eM&callback=initMap">
</script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>


  </head>

<style media="screen">
body{
  font-family: microsoft jhenghei;
}
</style>


  <body>


    <!-- navbar -->
<div id="navbar"></div>
<script type="text/javascript">
    var ajax = new XMLHttpRequest();
    ajax.open("GET", "/navbar.html", false);
    ajax.send();
    document.getElementById("navbar").innerHTML += ajax.responseText;
</script>
<script type="text/javascript">$(".button-collapse").sideNav();</script>

  <!-- navbar -->


  <div class="card">
    <!-- <div class="card-title" style="font-weight:bold;">
      訂單資料
    </div> -->
    <div class="card-tabs">
      <ul class="tabs tabs-fixed-width">
        <li class="tab"><a class="active" href="#test4" id="a_tab1">基本資料</a></li>
        <li class="tab"><a href="#test5" id="a_tab2">訂購餐點</a></li>
        <li class="tab"><a href="#test6" id="a_tab3">查看他人</a></li>
      </ul>
    </div>
    <div class="card-content grey lighten-4">


      <div id="test4">



        <div class="card" id="form1">


          <div class="card-content">

        <form class="" action="javascript:writeData()" method="post">

          單號 <input type="text" id="OrderId" value="" placeholder="OrderId" disabled>
          名字 <input type="text" id="OrderName" value="" placeholder="OrderName">
          電話 <input type="text" id="TEL" value="" placeholder="TEL">
          地址 <input type="text" id="Address" value="" placeholder="Address">
          時間 <input type="text" id="OrderTime" class="timepicker value=" >


          狀態<input type="number" id="OrderStatus" value="1" placeholder="OrderStatus">
          <input type="submit" value="下一步" id="submit" class="btn">

          <br>




        </form>
    </div>
  </div>



      </div>
      <div id="test5">



        <div id="div_products">
        </div>







      </div>
      <div id="test6">



        <button type="button" name="button" onclick="javascript:check()" class="btn">查看目前訂購</button>

        <div class="card">
        <div class="card-content" id="joinPeople">
        </div></div>






      </div>
    </div>
  </div>











<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDd2rFHwPXyIkq0iRSinBBfzg31NYJLapE",
    authDomain: "nchumis2017-5566.firebaseapp.com",
    databaseURL: "https://nchumis2017-5566.firebaseio.com",
    projectId: "nchumis2017-5566",
    storageBucket: "nchumis2017-5566.appspot.com",
    messagingSenderId: "501160127423"
  };
  firebase.initializeApp(config);


  /////////////////初始化////////////////////

  var database = firebase.database();

//////////////init products/////////////////////

function initBento(){
  var numBento;
  database.ref("Products/Bento/Data/").once("value", function(snapshot) {
    numBento = snapshot.numChildren();
    for(var i = 1 ;i<=numBento ; i++){
    var a = snapshot.child("Bento"+i+"/ProductName/").val();
    var b = snapshot.child("Bento"+i+"/ProductIntro/").val();
    var c = snapshot.child("Bento"+i+"/ProductPrice/").val();
    var div_products = document.getElementById("div_products");

    div_products.innerHTML+="<div class='card'><div class='card-content'>品名:<span id='name"+i+"'>"+a+"</span><br>價格:<span id='price"+i+"'>"+c+" </span><br>數量<span id = 'number"+i+"'>0</span><br>小計:<span id='total"+i+"'>0</span><br><div id='people_in"+i+"'><button type='button' class='btn' onclick='javascript:add_number("+i+")' >+</button> <button type='button'  class='btn' onclick='javascript:del_number("+i+")' >-</button></div></div></div>";
  }
});
}

/////////////////////


function add_number(i){
  var name_i = document.getElementById("name"+i).innerHTML;
  var price_i = document.getElementById("price"+i).innerHTML;
  var number_i = document.getElementById("number"+i);


  ++number_i.innerHTML;
  document.getElementById("total"+i).innerHTML=price_i*number_i.innerHTML;
  var total_i = document.getElementById("total"+i).innerHTML;
  var number_inner = number_i.innerHTML;

  ///////count price//////

  var OrderId = document.getElementById("OrderId").value;
  var OrderName = document.getElementById("OrderName").value;

  database.ref("Orders/"+OrderId+"/OrderDetail/"+"Bento"+i+"/"+"OrderPeople/"+OrderName+"/").set({
    number : number_inner,
    price : price_i,
    total : total_i
  });


}
function del_number(i){
  var name_i = document.getElementById("name"+i).innerHTML;
  var price_i = document.getElementById("price"+i).innerHTML;
  var number_i = document.getElementById("number"+i);

  if(number_i.innerHTML!=0){

    --number_i.innerHTML;
    document.getElementById("total"+i).innerHTML=price_i*number_i.innerHTML;
    var total_i = document.getElementById("total"+i).innerHTML;
    var number_inner = number_i.innerHTML;

    ///////count price//////

    var OrderId = document.getElementById("OrderId").value;
    var OrderName = document.getElementById("OrderName").value;

    database.ref("Orders/"+OrderId+"/OrderDetail/"+"Bento"+i+"/"+"OrderPeople/"+OrderName+"/").set({
      number : number_inner,
      price : price_i,
      total : total_i
    });

}

}
/////////////////////////////////////////////////////





  //////////////寫資料/////////////////////

  var ref = firebase.database().ref("Orders/");
  // ref.once("value").then(function(snapshot) {
  //     var counter = snapshot.numChildren();
  //     document.getElementById("OrderId").value = ++counter;
  //     document.getElementById("OrderId").value = "Order"+document.getElementById("OrderId").value
  //   });


  function writeData(){

    var OrderId = document.getElementById("OrderId").value;
    var OrderName = document.getElementById("OrderName").value;
    var TEL = document.getElementById("TEL").value;
    var Address = document.getElementById("Address").value;
    var OrderTime = document.getElementById("OrderTime").value;
    var OrderStatus = document.getElementById("OrderStatus").value;
    database.ref("Orders/"+OrderId).set({

      OrderId:OrderId,
      OrderStatus:OrderStatus,
      OrderInfo:{
        OrderMainName:OrderName,
        TEL : TEL,
        Address : Address,
        OrderTime : OrderTime
      }
    });

initBento();

    var submit_btn = document.getElementById("submit");
    submit_btn.disabled = true;
    submit_btn.value = "開始訂餐";
  }




//////////////////read people orders////////////////////////
function check(){
var OrderId = document.getElementById("OrderId").value;

database.ref("Orders/"+OrderId+"/OrderDetail/").on("value", function(snapshot) {

  var DetailBentoNum = snapshot.numChildren();
  document.getElementById("joinPeople").innerHTML="";
  for(var i = 1 ;i<=DetailBentoNum ; i++){
    var a = snapshot.child("Bento"+i+"/"+"OrderPeople/").val();
    document.getElementById("joinPeople").innerHTML+="Bento"+i+":"+JSON.stringify(a)+"<br>";

  }

});
}
  /////////////////////////////////////




</script>
<script type="text/javascript">
$('.timepicker').pickatime({
default: 'now', // Set default time: 'now', '1:30AM', '16:30'
fromnow: 0,       // set default time to * milliseconds from now (using with default = 'now')
twelvehour: false, // Use AM/PM or 24-hour format
donetext: 'OK', // text for done-button
cleartext: 'Clear', // text for clear-button
canceltext: 'Cancel', // Text for cancel-button
autoclose: false, // automatic close timepicker
ampmclickable: true, // make AM PM clickable
aftershow: function(){} //Function for after opening timepicker
});
</script>

<script type="text/javascript">
//////////getURL///
function getURL() {
    var url = location.href;
    var decode = decodeURIComponent(url);
    var temp = decode.split("?");
    var vars = temp[1].split("&");
    console.log(vars[0]);
    document.getElementById("OrderId").value=vars[0];

 }
 getURL();
//////////////////

</script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
    .map {
        width: 640px;
        height: 480px;
    }
    .labels {
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 4px;
    color: white;
    padding: 4px
}
    </style>

  </head>
<body>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
  <script src="jquery-3.3.1.js"></script>
  <script src="jquery.tinyMap.js"></script>
  <div class="map"></div>
<script>
  //initialize google map////////////
  $.fn.tinyMapConfigure({
    'key': 'AIzaSyBmKFudinNxKD27eVaOUsBBaqEEt9o0ONQ',
    'libraries': 'geometry',
    // 使用的地圖語言
    'language': 'zh‐TW',
});
  ////////////////////////////////
  // Initialize
  var config = {
    apiKey: "AIzaSyDd2rFHwPXyIkq0iRSinBBfzg31NYJLapE",
    authDomain: "nchumis2017-5566.firebaseapp.com",
    databaseURL: "https://nchumis2017-5566.firebaseio.com",
    projectId: "nchumis2017-5566",
    storageBucket: "nchumis2017-5566.appspot.com",
    messagingSenderId: "501160127423"
  };
  firebase.initializeApp(config);
  var loc=new Array();
  var current=new Array();
  var distance =new Array();
  var now;

  /////////////////取得位置資訊////////////////////
function getAddress(){
  var query = firebase.database().ref("Orders").orderByKey();
  query.once("value").then(function(snapshot) {
    snapshot.forEach(function(childSnapshot) {
      var ref = firebase.database().ref("Orders/"+childSnapshot.key+"/OrderInfo/");
      ref.once("value")
        .then(function(snapshot) {
          $('.map').tinyMap('query', snapshot.child("Address").val(), function (addr) {
            loc.push({'addr':[addr.geometry.location.lat(),addr.geometry.location.lng()],'text':snapshot.ref.parent.key})
  });
      });
    });
  },function(error) {
  // The Promise was rejected.
  console.error(error);
});
}

///////////////////////Initializemap////////////////////


  $('.map').tinyMap({
  'center': ['24.1175214', '120.6738148'],
  'zoom': 10,
});

function getDistant(){
  distance.length = 0;

  $('.map').tinyMap('modify',{
  'marker': loc,
  'markerFitBounds': true,
  'event': {
    'idle': {
      'func': function () {
          Farthest = false,
          // 取得目前地圖中心
          now = new google.maps.LatLng(current[0], current[1]);

        $('.map').tinyMap('get', 'marker', function (markers) {
            markers.forEach(function (marker) {
              var meters = 0;
              // 忽略標有 ignore: true 屬性的標記
              if (!marker.hasOwnProperty('ignore')) {
              meters = google.maps.geometry.spherical.computeDistanceBetween(marker.getPosition(),now);
              distance.push(meters);
              console.log(meters);
            }
          });
              Farthest = distance.indexOf(Math.max.apply(Math, distance));
              if (false !== Farthest && -1 !== Farthest) {
                  if ('undefined' !== typeof markers[Farthest].infoWindow) {
                    // 開啟此標記的 infoWindow
                    markers[Farthest].infoWindow.open(this, markers[Farthest]);
                      // 移動此標記至地圖中心
                      this.panTo(markers[Farthest].position);
                  }
              }
          });
        },'once': true // 僅執行一次
      }
    }
    });
    }

/////////////////getNowPosition//////////////////
function getNowPosition(){
var getPosition = function (options) {
  return new Promise(function (resolve, reject) {
    navigator.geolocation.getCurrentPosition(resolve, reject, options);
  });
}
getPosition()
  .then((position) => {
    current=[position.coords.latitude,position.coords.longitude];
    $('.map').tinyMap('modify',{
      'marker':[{'addr': current, 'text': '目前位置'},
    ],
  }
  )
    console.log(position);
  })
  .catch((err) => {
    console.error(err.message);
  });
}
/////////////////////////////////

function pantomap(){
  $('.map').tinyMap('panTo', [current[0],current[1]]);
}


window.setInterval("getAddress()",2000);
  /////////////////////////////////////
  </script>
  <button type="button" onclick="getNowPosition()">取得目前位置</button>
  <button type="button" onclick="getDistant()">計算路徑</button>
  </body>
</html>

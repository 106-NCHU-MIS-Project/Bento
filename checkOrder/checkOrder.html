<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

	    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    <link href='https://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet'>

    <!-- <link rel="stylesheet" href="../css/main.css"> -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzUkUrvdaygSJamPdIUkADw4qTuosDjkw" async defer></script>
<style media="screen">

body{
  font-family: microsoft jhenghei;
  font-weight: bold;
}
td{
}

th{
  text-align: center;
  font-weight: bolder;
}
.td_center{
  text-align: center;
  width: 50%;
}
</style>

    <title>查看訂單</title>
  </head>


  <body>


    <nav>
      <div class='nav-wrapper #00838f cyan darken-4'>
        <a href='../index.html' class='brand-logo'>BENTO</a>
        <div  style="float:left;position:relative;z-index:1; margin:0 18px;" onclick="javascript:modal_open()"><i class='material-icons'>info_outline</i></div>

      </div>
    </nav>

    <script type="text/javascript">$(".button-collapse").sideNav();</script>




<div class="" id="div_order_content">

  <!-- <h5><p id="p_info">目前沒有訂單</p></h5> -->
<div class="container">
  <h5 style="font-weight:bolder;text-align:center;">訂單狀態</h5>
</div>


<div class="row" style="margin-bottom:0px;">
  <table style="border:1px">
    <tr>
      <td id="OrderStatus_1" style="background-color:#eeeeee;text-align:center;">接收訂單</td>
      <td id="OrderStatus_2" style="background-color:#eeeeee;text-align:center;">餐點製作</td>
      <td id="OrderStatus_3" style="background-color:#eeeeee;text-align:center;">正在外送</td>
      <td id="OrderStatus_4" style="background-color:#eeeeee;text-align:center;">訂單完成</td>
    </tr>
    <tr>
      <td colspan="4" style="padding-top:0px;padding-bottom:0px;">
        <div class="progress">
          <div id="progressBarDiv" class="determinate" style="width:0%"></div>
        </div>
      </td>
    </tr>
  </table>

</div>



  <div class="card" style="margin-top:0px;">

    <div class="card-tabs">
      <ul class="tabs tabs-fixed-width">
        <li class="tab"><a href="#test4">訂單資訊</a></li>
        <li class="tab"><a href="#test5">外送狀態</a></li>
        <li class="tab"><a href="#test6">團購收費</a></li>
      </ul>
    </div>
    <div class="card-content grey lighten-4" style="padding-top:12px;padding-bottom:12px;">
      <div id="test4">

<div class="card">
  <div class="card-content">


        <table class="highlight">
          <tr>
          <td width="40%">訂單序號</td><td id="OrderId"></td>
          </tr>
          <tr>
          <td width="40%">訂餐人</td><td id="OrderMainName"></td>
          </tr>
          <tr>
            <td width="40%">送餐地址</td><td id="Address"></td>
          </tr>
          <tr>
            <td width="40%">預計送餐時間</td><td id="OrderTime"></td>
          </tr>



        </table>
        <table >
          <tr>
            <td colspan="2" style="text-align:center;"><hr>訂購餐點</td>
          </tr>
          <tr style="background-color:#f2f2f2;">
            <th>品項</th><th>數量</th>
          </tr>

        </table>
        <table class="highlight" id="OrderDetail_inTable">

        </table>

  </div>
</div>
      </div>
      <div id="test5"></div>
      <div id="test6">
        <div class="card">

        <div class="card-content" id="joinPeople">
          <form action="#">




          </form>

        </div>
        </div>
      </div>
    </div>
  </div>


</div>










<!-- Modal Structure -->
<div id="modal1" class="modal">
  <div class="modal-content">
    <h4 id="OrderListShop_h4_inModal"></h4>
    <hr>
    <table class="highlight">
      <tr>
        <td>電話</td><td id="TEL_inModal">04-22882288</td>
      </tr>
      <tr>
        <td>地址</td><td id="address_inModal">台中市南區興大路140號</td>
      </tr>

    </table>

  </div>
  <div class="modal-footer">
    <div class="modal-action modal-close waves-effect waves-green btn-flat">OK</div>
  </div>
</div>
<!-- . -->

  </body>





<script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>

<script type="text/javascript">
var url = location.href;
var decode = decodeURIComponent(url);
var temp = decode.split("?");
var vars = temp[1].split("&");
console.log(vars[0]+","+vars[1]);
document.getElementById("OrderListShop_h4_inModal").innerHTML = vars[1];
document.getElementById("OrderId").innerHTML = vars[0];
var shop_i;

    // var config = {
    //   apiKey: "AIzaSyDHJvCW6LwYl0fih2PynaWmX3fYGqmel00",
    //   authDomain: "all-store-a0408.firebaseapp.com",
    //   databaseURL: "https://all-store-a0408.firebaseio.com",
    //   projectId: "all-store-a0408",
    //   storageBucket: "",
    //   messagingSenderId: "982261178985"
    // };
    // firebase.initializeApp(config);
    //
    // var database = firebase.database();
    //
    // database.ref("stores").once("value",function(snapshot){
    //   var shop_counter = snapshot.child("counter").val();
    //   console.log(shop_counter);
    //   for(var i = 1 ; i<=shop_counter ; i++){
    //     var shopName = snapshot.child("shop"+i+"/shopName").val();
    //     console.log(shopName);
    //     if(vars[1]==shopName){
    //       shop_i = i;
    //       document.getElementById("TEL_inModal").innerHTML = snapshot.child("shop"+shop_i+"/shopInfo/tel").val();
    //       document.getElementById("address_inModal").innerHTML = snapshot.child("shop"+shop_i+"/shopInfo/address").val();
    //     }
    //   }
    // });

</script>




<script type="text/javascript">


$(document).ready(function(){
  // the "href" attribute of the modal trigger must specify the modal ID that wants to be triggered
  $('.modal').modal();
});
function modal_open(){
  $(document).ready(function(){
    $('#modal1').modal('open');

  });
}
</script>


<script type="text/javascript">
// Initialize Firebase
var config = {
  apiKey: "AIzaSyDd2rFHwPXyIkq0iRSinBBfzg31NYJLapE",
  authDomain: "nchumis2017-5566.firebaseapp.com",
  databaseURL: "https://nchumis2017-5566.firebaseio.com",
  projectId: "nchumis2017-5566",
  storageBucket: "nchumis2017-5566.appspot.com",
  messagingSenderId: "501160127423"
};
firebase.initializeApp(config);


/////////////////初始化////////////////////

var database = firebase.database();

console.log("Orders/"+vars[0]);


database.ref("Orders/"+vars[0]).on("value",function(snapshot){
  document.getElementById("OrderMainName").innerHTML = snapshot.child("OrderInfo/OrderMainName").val();;
  document.getElementById("Address").innerHTML = snapshot.child("OrderInfo/Address").val();
  document.getElementById("OrderTime").innerHTML = snapshot.child("OrderInfo/OrderTime").val();


  ///////////////////on  OrderStatus //////////////////////////
  var OrderStatus = snapshot.child("OrderStatus").val();
  if(OrderStatus==1){
    document.getElementById("progressBarDiv").style.width = "24.2%";
    var temp = document.getElementById("OrderStatus_1");
    temp.style.backgroundColor = "#9e9e9e";
    temp.color = "white";
  }
  else if(OrderStatus==2){
    document.getElementById("progressBarDiv").style.width = "50%";
    var temp = document.getElementById("OrderStatus_2");
    temp.style.backgroundColor = "#9e9e9e";
    temp.color = "white";
  }
  else if(OrderStatus==3){
    document.getElementById("progressBarDiv").style.width = "75.8%";
    var temp = document.getElementById("OrderStatus_3");
    temp.style.backgroundColor = "#9e9e9e";
    temp.color = "white";
  }
  else if(OrderStatus==4){
    document.getElementById("progressBarDiv").style.width = "100%";
    var temp = document.getElementById("OrderStatus_4");
    temp.style.backgroundColor = "#9e9e9e";
    temp.color = "white";
  }


    ///////////////////on  OrderStatus //////////////////////////

var BentoCounter = snapshot.child("OrderDetail/").numChildren()-1;
//////////bento1 bento2 bento3 and time column  so  -1/////////////

console.log(BentoCounter);
for(var j = 1 ; j <= BentoCounter ; j++){
  var temp = snapshot.child("OrderDetail/Bento"+j+"/name/").val();
  var BentoName = [];
  BentoName[j] = temp;

  var Bento_j_counter = [];
  Bento_j_counter[j] = 0;

  // console.log(BentoName[j]);
  snapshot.child("OrderDetail/Bento"+j+"/OrderPeople/").forEach(function(childSnapshot){
    var peopleName = childSnapshot.key;
    var  child_isPaid = childSnapshot.child("isPaid").val();
    var  child_name = childSnapshot.child("name").val();
    var  child_number = parseInt(childSnapshot.child("number").val());
    var  child_price = childSnapshot.child("price").val();
    var  child_total = childSnapshot.child("total").val();
    Bento_j_counter[j] = child_number+Bento_j_counter[j];

  });
  console.log(BentoName[j]+","+Bento_j_counter[j]);
  document.getElementById("OrderDetail_inTable").innerHTML += "<tr><td class='td_center'>"+BentoName[j]+"</td><td class='td_center'>"+Bento_j_counter[j]+"</td></tr>";
}


});

</script>


<script type="text/javascript">


database.ref("Orders/"+vars[0]+"/OrderDetail").on("value", function(snapshot) {

  var DetailBentoNum = snapshot.numChildren()-1;
  document.getElementById("joinPeople").innerHTML="";
  for(var i = 1 ;i<=DetailBentoNum ; i++){


    var query = firebase.database().ref("Orders/"+vars[0]+"/OrderDetail/"+"Bento"+i+"/"+"OrderPeople/").orderByKey();
    query.once("value").then(function(snapshot) {
        snapshot.forEach(function(childSnapshot) {

          var key = childSnapshot.key;

          var childNumber = childSnapshot.child("number").val();
          var childPrice = childSnapshot.child("price").val();
          var childTotal = childSnapshot.child("total").val();
          var childBento = childSnapshot.child("name").val();
          if(childNumber!=0){
          document.getElementById("joinPeople").innerHTML+="<div class='row'><div class='col s12'><b><p>"+key+":"+childBento+"</p></b><p>數量:"+childNumber+" 價格:"+childPrice+" 小計:"+childTotal+"</p><p><input type='checkbox' id='indeterminate-checkbox'/><label for='indeterminate-checkbox'>已付清</label></p></div></div><hr>";
          }
      });
    });


  }

});
</script>
</html>

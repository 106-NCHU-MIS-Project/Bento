<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.0.7/sweetalert2.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.0.7/sweetalert2.all.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    <title>查看訂單-店名</title>
    <script>
        $(document).ready(function () {
            $('.modal').modal();
        });


    </script>
</head>

<body>
    <nav>
        <div class="nav-wrapper">
            <a href="#" class="brand-logo">查看訂單</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li>
                    <a href="sass.html">Sass</a>
                </li>
                <li>
                    <a href="badges.html">Components</a>
                </li>
                <li>
                    <a href="collapsible.html">JavaScript</a>
                </li>
            </ul>
        </div>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyDd2rFHwPXyIkq0iRSinBBfzg31NYJLapE",
            authDomain: "nchumis2017-5566.firebaseapp.com",
            databaseURL: "https://nchumis2017-5566.firebaseio.com",
            projectId: "nchumis2017-5566",
            storageBucket: "nchumis2017-5566.appspot.com",
            messagingSenderId: "501160127423"
        };
        firebase.initializeApp(config);
        var database = firebase.database();
    </script>

    <div class="row">
        <ul id="list_orders" class="collapsible popout" data-collapsible="accordion"></ul>
    </div>
    <!-- Modal Trigger -->
    <!-- <a class="waves-effect waves-light btn modal-trigger" href="#modal1">Modal</a> -->
    
    <!-- Modal Structure -->
    <div id="modal1" class="modal">
        <div class="modal-content" id="modal1-content"></div>
        <div class="modal-footer" id="modal1-footer"></div>
    </div>
    <script>
        var ordersRef = database.ref("Orders/");
        // var have_content = false;
        ordersRef.on('value', function(snapshot){
            if (!snapshot.exists()) {
                $('#list_orders').empty();                
                
                var str = "";
                str += "<h1>尚無訂單資料</h1>";
                $('#list_orders').append(str);

            }
            else 
            {
                $('#list_orders').empty();                
                snapshot.forEach(function(childSnap){
                    var str ="";
                    str += '<li><div class="collapsible-header"><i class="material-icons">local_dining</i>'+ childSnap.key+'<span class="neworder new badge" data-badge-caption="" >新訂單</span></div>';
                    if(childSnap.val().OrderStatus == 0 )
                    {
                        // var str = "";
                        // str += "<h1>尚無訂單資料</h1>";
                        // $('#list_orders').append(str);
                        return;
                    }

             
                    var obj = childSnap.child("OrderDetail").val();
                    str += '<div class="collapsible-body"><ul>';
                    $.each(obj, function(key, value){
                        var num = 0;
                        if (key == "time")
                            return;
                        $.each(value.OrderPeople, function(person){
                            num += Number(value.OrderPeople[person].number);
                        });
                        

                        str += '<li>'+value.name+ ":"+ num+'</li>';
                    });
                    obj = childSnap.child("OrderInfo").val();
                    str += '<li><h5>訂購人資料</h5></li>';
                    
                    $.each(obj, function(key, value){
                        switch(key){
                            case "Address":
                            str += '<li>地址' + ":" + value + '</li>';
                            break;
                            case "OrderMainName":
                                str += '<li>訂購人' + ":" + value + '</li>';
                                break;
                            case "OrderTime":
                                str += '<li>訂購時間' + ":" + value + '</li>';
                                break;
                            case "TEL":
                                str += '<li>聯絡電話' + ":" + value + '</li>';
                                break;
                        }
            
                    });
                    str += '</ul>';
                    var order_id = childSnap.child("OrderId").val();
                    str += '<a href="#!" class="modal-action modal-close waves-effect waves-light btn right red" onclick="javascript:setOrderStatus(\'' + order_id + '\', 6)">拒絕訂單</a>';                    
                    str += '<a href="#!" class="modal-action modal-close waves-effect waves-green btn right" onclick="javascript:setOrderStatus(\'' + order_id + '\', 2)">接受訂單</a>';
                    str += '</div></li>';
                    $('#list_orders').append(str);

                });
            }

        });


        var newOrder;
        ordersRef.on('child_added', function(snapshot){
            var obj = snapshot.val();
            newOrder = obj.OrderId;
            receiveOrder(newOrder);
        });
        function receiveOrder(newOrder){
            $('#modal1-content').empty();
            $('#modal1-footer').empty();
            
            ordersRef.child(newOrder).on("value", function (snapshot) {
                $('#modal1-content').empty();
                $('#modal1-footer').empty();
                var newOrderObj = snapshot.val();
                if(newOrderObj.OrderStatus == 1)
                {
                    var str = '';
                    var footer = '';
                    str += '<h4>收到新訂單</h4>';
                    $.each(newOrderObj.OrderDetail, function(key, value){
                        if (key == 'time')
                            return;

                            var num = 0;

                            $.each(value.OrderPeople, function (person) {
                                num += Number(value.OrderPeople[person].number);
                                
                            });
                            str += value.name+":::::::"+num+"個<br/>";  

                    });
                     

                    str += '<h5>訂購人資料</h5>';

                    $.each(newOrderObj.OrderInfo, function (key, value) {
                        switch (key) {
                            case "Address":
                                str += '<li>地址' + ":" + value + '</li>';
                                break;
                            case "OrderMainName":
                                str += '<li>訂購人' + ":" + value + '</li>';
                                break;
                            case "OrderTime":
                                str += '<li>訂購時間' + ":" + value + '</li>';
                                break;
                            // case "TEL":
                            //     str += '<li>聯絡電話' + ":" + value + '</li>';
                            //     break;
                        }

                    });

                    footer += '<a href="#!" class="modal-action modal-close waves-effect waves-green btn" >確認</a>';
                    // footer += '<a href="#!" class="modal-action modal-close waves-effect waves-green btn" onclick="javascript:setOrderStatus(\'' + newOrder + '\', 2)">接受訂單</a>';


                    $('#modal1-content').append(str);
                    $('#modal1-footer').append(footer);
                    // if ($('#modal1-content').children().length == 0)
                        // $('#modal1').modal('close');
                    
                    $('#modal1').modal('open');
                }
                    
                // else {}

            });
        }
        function setOrderStatus(orderID, token){
            ordersRef.child(orderID+"/OrderStatus").set(token);
        }
        

    </script>
</body>

</html>